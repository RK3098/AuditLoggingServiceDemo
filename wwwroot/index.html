<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Audit Dashboard Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f0f0f0;
    }

    header {
      background-color: #111;
      color: white;
      padding: 15px 25px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    .kpis {
      display: flex;
      justify-content: space-around;
      margin: 20px;
    }

    .kpi-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      flex: 1;
      margin: 0 10px;
    }

    .kpi-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin-top: 10px;
    }

    .container {
      display: flex;
      gap: 20px;
      margin: 20px;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      padding: 16px;
      flex: 1;
    }

    #events-card {
      flex: 2;
    }

    #alerts-card {
      flex: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #333;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    #events {
      max-height: 420px;
      overflow-y: auto;
    }

    .alert-high {
      background: #ffcccc;
      padding: 10px;
      margin: 6px 0;
      border-left: 5px solid red;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .alert-medium {
      background: #fff3cd;
      padding: 10px;
      margin: 6px 0;
      border-left: 5px solid orange;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .alert-low {
      background: #d1ecf1;
      padding: 10px;
      margin: 6px 0;
      border-left: 5px solid blue;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    button {
      background: linear-gradient(90deg, #007bff, #0056b3);
      border: none;
      color: white;
      padding: 10px 20px;
      margin-top: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    button:hover {
      background: linear-gradient(90deg, #0056b3, #003f7f);
      transform: scale(1.05);
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
</head>
<body>
  <header>ðŸ”’ Real-time Security & Compliance Dashboard</header>

  <!-- KPI Cards -->
  <div class="kpis">
    <div class="kpi-card">
      <div>Total Events</div>
      <div class="kpi-value" id="kpi-events">0</div>
    </div>
    <div class="kpi-card">
      <div>Total Alerts</div>
      <div class="kpi-value" id="kpi-alerts">0</div>
    </div>
    <div class="kpi-card">
      <div>Compliance Health</div>
      <div class="kpi-value" id="kpi-health">100%</div>
    </div>
  </div>

  <div class="container">
    <!-- Left side: Events -->
    <div class="card" id="events-card">
      <h3>Live Events</h3>
      <table>
        <thead>
          <tr><th>Time</th><th>User</th><th>Action</th><th>Resource</th></tr>
        </thead>
        <tbody id="events"></tbody>
      </table>
    </div>

    <!-- Right side: Alerts -->
    <div class="card" id="alerts-card">
      <h3>Alerts</h3>
      <div id="alerts"></div>
      <h3>DB Evidence</h3>
      <button onclick="openFauxton()">Open CouchDB Fauxton</button>
    </div>
  </div>

  <script>
    const eventsTbody = document.getElementById('events');
    const alertsDiv = document.getElementById('alerts');

    const kpiEvents = document.getElementById('kpi-events');
    const kpiAlerts = document.getElementById('kpi-alerts');
    const kpiHealth = document.getElementById('kpi-health');

    let totalEvents=0, totalAlerts=0;

    const conn = new signalR.HubConnectionBuilder().withUrl("/auditHub").withAutomaticReconnect().build();

    conn.on("NewEvent", ev => {
      addEvent(ev);
      recomputeKPIs();
    });

    conn.on("Alert", a => {
      addAlert(a);
      recomputeKPIs();
    });

    conn.start().catch(e => console.error("SignalR start error:", e));

    function addEvent(ev){
      totalEvents++;
      const tr = document.createElement('tr');
      const t = new Date(ev.timestamp || ev.receivedAt || Date.now()).toLocaleTimeString();
      tr.innerHTML = `<td>${t}</td><td>${ev.userId}</td><td>${ev.action}</td><td>${ev.resource||''}</td>`;
      eventsTbody.prepend(tr);
      while(eventsTbody.children.length>20) eventsTbody.removeChild(eventsTbody.lastChild);
    }

    function addAlert(a){
      totalAlerts++;
      const d = document.createElement('div');
      let cls = 'alert-low';
      if (a.severity === 'HIGH') cls = 'alert-high';
      else if (a.severity === 'MEDIUM') cls = 'alert-medium';
      d.className = cls;
      d.innerHTML = `<strong>${a.severity}</strong> - ${a.reason} <br/><small>${new Date(a.createdAt).toLocaleTimeString()}</small>`;
      alertsDiv.prepend(d);
      while(alertsDiv.children.length>10) alertsDiv.removeChild(alertsDiv.lastChild);
    }

    function recomputeKPIs(){
      const health = Math.round((1 - (totalAlerts / Math.max(1, totalEvents))) * 100);

      kpiEvents.textContent = totalEvents;
      kpiAlerts.textContent = totalAlerts;
      kpiHealth.textContent = `${health}%`;

      // color coding
      if(health > 80) kpiHealth.style.color = 'green';
      else if(health > 50) kpiHealth.style.color = 'orange';
      else kpiHealth.style.color = 'red';
    }

    function openFauxton(){ window.open("http://localhost:5984/_utils/", "_blank"); }
  </script>
</body>
</html>
